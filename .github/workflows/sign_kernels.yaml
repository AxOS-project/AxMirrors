name: Check Arch Kernel Updates

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-kernel:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    outputs:
      lts_updated: ${{ steps.detect.outputs.lts_updated }}
      normal_updated: ${{ steps.detect.outputs.normal_updated }}
      zen_updated: ${{ steps.detect.outputs.zen_updated }}
      any_updated: ${{ steps.detect.outputs.lts_updated == 'true' || steps.detect.outputs.normal_updated == 'true' || steps.detect.outputs.zen_updated == 'true' }}

    env:
      SB_KEY: ${{ secrets.AXOS_SBP_KEY }}

    steps:
      - uses: actions/cache@v4
        name: Restore Kernel cache
        with:
          path: kernel-cache.txt
          key: kernel-cache
          restore-keys: |
            kernel-cache

      - name: Install dependencies
        run: |
          pacman -Sy --noconfirm jq curl libarchive sbsigntools git pacman-contrib ca-certificates openssl
          update-ca-trust

      - name: Fetch Arch package data
        run: |
          curl -s --retry 5 --retry-delay 5 https://archlinux.org/packages/core/x86_64/linux/json/ -o linux.json
          curl -s --retry 5 --retry-delay 5 https://archlinux.org/packages/core/x86_64/linux-lts/json/ -o linux-lts.json
          curl -s --retry 5 --retry-delay 5 https://archlinux.org/packages/extra/x86_64/linux-zen/json/ -o linux-zen.json

      - name: Read versions
        id: versions
        run: |
          LTS=$(jq -r '.pkgver + "-" + .pkgrel' linux-lts.json)
          NORMAL=$(jq -r '.pkgver + "-" + .pkgrel' linux.json)
          ZEN=$(jq -r '.pkgver + "-" + .pkgrel' linux-zen.json)
          echo "lts=$LTS" >> $GITHUB_OUTPUT
          echo "normal=$NORMAL" >> $GITHUB_OUTPUT
          echo "zen=$ZEN" >> $GITHUB_OUTPUT

      - name: Compare versions
        id: detect
        run: |
          CACHE_FILE="kernel-cache.txt"

          if [ ! -f "$CACHE_FILE" ]; then
            printf "%s\n%s\n%s\n" \
              "${{ steps.versions.outputs.lts }}" \
              "${{ steps.versions.outputs.normal }}" \
              "${{ steps.versions.outputs.zen }}" > "$CACHE_FILE"
            echo "lts_updated=true" >> $GITHUB_OUTPUT
            echo "normal_updated=true" >> $GITHUB_OUTPUT
            echo "zen_updated=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          read OLD_LTS OLD_NORMAL OLD_ZEN < <(cat "$CACHE_FILE")

          if [ "${{ steps.versions.outputs.lts }}" != "$OLD_LTS" ]; then
            echo "lts_updated=true" >> $GITHUB_OUTPUT
          else
            echo "lts_updated=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.versions.outputs.normal }}" != "$OLD_NORMAL" ]; then
            echo "normal_updated=true" >> $GITHUB_OUTPUT
          else
            echo "normal_updated=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.versions.outputs.zen }}" != "$OLD_ZEN" ]; then
            echo "zen_updated=true" >> $GITHUB_OUTPUT
          else
            echo "zen_updated=false" >> $GITHUB_OUTPUT
          fi

          printf "%s\n%s\n%s\n" \
            "${{ steps.versions.outputs.lts }}" \
            "${{ steps.versions.outputs.normal }}" \
            "${{ steps.versions.outputs.zen }}" > "$CACHE_FILE"


      - uses: actions/cache/save@v4
        name: Save Kernel cache
        if: always()
        with:
          path: kernel-cache.txt
          key: kernel-cache-${{ github.run_id }}

      - name: Write Secure Boot key
        run: |
          echo "$SB_KEY" > sb.key

      - name: Clone Secure Boot cert
        run: |
          git clone https://github.com/AxOS-project/axos-secureboot-keys.git keys-repo
          cp keys-repo/db.crt sb.crt

      - name: Download, sign, and package kernels
        if: steps.detect.outputs.normal_updated == 'true' ||
            steps.detect.outputs.lts_updated == 'true' ||
            steps.detect.outputs.zen_updated == 'true'
        run: |
          mkdir -p /tmp/tmp.hID92JxQ52/
          download_and_sign() {
            TYPE=$1
            VERSION=$2
            PKG="linux"
            REPO="core"
            if [ "$TYPE" = "lts" ]; then
                PKG="linux-lts"
            elif [ "$TYPE" = "zen" ]; then
                PKG="linux-zen"
                REPO="extra"
            fi
            FILE="${PKG}-${VERSION}-x86_64.pkg.tar.zst"
            URL="https://archlinux.org/packages/$REPO/x86_64/$PKG/download/"
            curl -fL "$URL" -o "$FILE"
            mkdir -p extract
            bsdtar -xf "$FILE" -C extract
            KERNEL=$(find extract/usr/lib/modules -maxdepth 2 -type f -name 'vmlinuz*' | head -n 1)
            sbsign --key sb.key --cert sb.crt --output "$KERNEL.signed" "$KERNEL"
            mv "$KERNEL.signed" "$KERNEL"
            bsdtar -cf "$FILE" -C extract .
            rm -rf extract
            cp "$FILE" /tmp/tmp.hID92JxQ52/
          }
          [ "${{ steps.detect.outputs.lts_updated }}" = "true" ] && download_and_sign lts "${{ steps.versions.outputs.lts }}"
          [ "${{ steps.detect.outputs.normal_updated }}" = "true" ] && download_and_sign normal "${{ steps.versions.outputs.normal }}"
          [ "${{ steps.detect.outputs.zen_updated }}" = "true" ] && download_and_sign zen "${{ steps.versions.outputs.zen }}"
          
      - name: Upload signed kernels
        uses: actions/upload-artifact@v4
        if: steps.detect.outputs.normal_updated == 'true' ||
            steps.detect.outputs.lts_updated == 'true' ||
            steps.detect.outputs.zen_updated == 'true'
        with:
          name: signed-kernels
          path: /tmp/tmp.hID92JxQ52/*.pkg.tar.zst

  push-changes:
    runs-on: ubuntu-latest
    needs: check-kernel
    if: needs.check-kernel.outputs.any_updated == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download signed kernels
        uses: actions/download-artifact@v4
        with:
          name: signed-kernels
          path: ${{ github.workspace }}/new

      - name: Add new packages
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":"$GITHUB_WORKSPACE" \
            -w "$GITHUB_WORKSPACE" \
            archlinux:latest \
            sh -c "pacman -Sy --noconfirm pacman-contrib && ./add_new_pkgs.sh"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add new/*
          git add testing/* x86_64/* || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update signed kernel packages"
            git push origin HEAD:main
          fi